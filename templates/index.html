<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirx</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: #000;
            min-height: 100vh; 
            color: #fff;
            position: relative;
            overflow-x: hidden;
            cursor: none;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse farthest-corner at center, #666 0%, #333 40%, #000 100%);
        }
        .card { 
            background: rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            z-index: 1;
        }
        .btn-shorten { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border: none; 
            color: white;
        }
        .btn-shorten:hover { 
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); 
            color: white;
        }
        .short-url { 
            background: rgba(255,255,255,0.1); 
            padding: 10px; 
            border-radius: 5px; 
            word-break: break-all; 
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .qr-container { text-align: center; margin-top: 20px; }
        .qr-img { max-width: 200px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px; }
        .form-section { margin-bottom: 20px; }
        .form-control, .form-control-color { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
        .form-control::placeholder { color: rgba(255,255,255,0.7); }
        .form-control:focus { background: rgba(255,255,255,0.15); border-color: #667eea; color: #fff; }
        .form-check-input:checked { background-color: #667eea; border-color: #667eea; }
        .nav-tabs .nav-link { color: rgba(255,255,255,0.8); }
        .nav-tabs .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
        .alert { border: none; }
        .alert-info { background: rgba(13, 202, 240, 0.2); border-left: 4px solid #0dc5e8; }
        .alert-danger { background: rgba(220, 53, 69, 0.2); border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="container">
        <div class="card mx-auto">
            <div class="card-body p-4">
                <h1 class="text-center mb-4"><i class="fas fa-link"></i> Redirx</h1>
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-info">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button">Single Link</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button">Bulk CSV</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="single" role="tabpanel">
                        {% if error %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endif %}
                        <form method="POST" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-12 form-section">
                                    <label for="long_url" class="form-label">Long URL:</label>
                                    <input type="url" class="form-control" id="long_url" name="long_url" placeholder="https://example.com/long/path" required>
                                </div>
                                <div class="col-md-6 form-section">
                                    <label for="custom_code" class="form-label">Custom Code (optional):</label>
                                    <input type="text" class="form-control" id="custom_code" name="custom_code" placeholder="e.g., ABC123" maxlength="{{ short_code_length }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 form-section">
                                    <label for="ab_urls" class="form-label">Rotate targets (comma-separated alternatives to the long URL, optional):</label>
                                    <input type="text" class="form-control" id="ab_urls" name="ab_urls" placeholder="https://alt1.com,https://alt2.com">
                                </div>
                            </div>
                            <div class="row form-section">
                                <div class="col-md-6">
                                    <label for="password" class="form-label">Password (optional):</label>
                                    <input type="password" class="form-control" id="password" name="password" placeholder="Protect redirect">
                                </div>
                                <div class="col-md-6">
                                    <label for="expiry_hours" class="form-label">Expiry (hours):</label>
                                    <input type="number" class="form-control" id="expiry_hours" name="expiry_hours" value="24" min="1">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="disable_expiry" name="disable_expiry">
                                        <label class="form-check-label" for="disable_expiry">Disable expiry</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row form-section">
                                <div class="col-md-6">
                                    <label class="form-label">Start Time (optional):</label>
                                    <input type="date" class="form-control mb-1" id="start_date" name="start_date">
                                    <input type="time" class="form-control" id="start_time" name="start_time">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Time (optional):</label>
                                    <input type="date" class="form-control mb-1" id="end_date" name="end_date">
                                    <input type="time" class="form-control" id="end_time" name="end_time">
                                </div>
                            </div>
                            <div class="row form-section">
                                <div class="col-md-6">
                                    <label for="qr_color" class="form-label">QR Foreground Color:</label>
                                    <input type="color" class="form-control form-control-color" id="qr_color" name="qr_color" value="{{ default_qr_color }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="qr_bg" class="form-label">QR Background Color:</label>
                                    <input type="color" class="form-control form-control-color" id="qr_bg" name="qr_bg" value="{{ default_qr_bg }}">
                                </div>
                            </div>
                            <div class="row form-section">
                                <div class="col-md-12">
                                    <label for="logo_file" class="form-label">QR Logo (optional PNG):</label>
                                    <input type="file" class="form-control" id="logo_file" name="logo_file" accept="image/png">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-shorten btn-lg w-100">
                                <i class="fas fa-magic"></i> Shorten URL
                            </button>
                        </form>
                        {% if short_url %}
                            <div class="mt-4">
                                <h5>Your short URL:</h5>
                                <div class="short-url">{{ short_url }}</div>
                                <button class="btn btn-outline-secondary mt-2 me-2" onclick="navigator.clipboard.writeText('{{ short_url }}'); this.innerText='Copied!';">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <a href="{{ stats_url }}" class="btn btn-outline-info mt-2 me-2">
                                    <i class="fas fa-chart-bar"></i> Stats
                                </a>
                                <a href="{{ short_url }}/qr" class="btn btn-outline-success mt-2" download>
                                    <i class="fas fa-qrcode"></i> Download QR
                                </a>
                                <div class="qr-container">
                                    <h6>QR Code:</h6>
                                    <img src="data:image/png;base64,{{ qr_data }}" alt="QR Code" class="qr-img">
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="tab-pane fade" id="bulk" role="tabpanel">
                        <form method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="csv_file" class="form-label">Upload CSV (columns: long_url, optional custom_code):</label>
                                <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                                <div class="form-text">Example: long_url\nhttps://example.com/1\nhttps://example.com/2</div>
                            </div>
                            <button type="submit" class="btn btn-shorten btn-lg w-100">Process Bulk</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Updated Canvas Script - Circles Spawn Randomly and Disappear (No Lines)
        var canvas = {
            $el: undefined,
            ctx: undefined,
            draw: function () {
                canvas.clear();
                canvas.callback();
                canvas.raf(canvas.draw);
            },
            clear: function () {
                canvas.ctx.clearRect(0, 0, canvas.$el.width, canvas.$el.height);
            },
            ellipse: function (opt) {
                opt = canvas.formatSize(opt);
                canvas.drawElement(function () {
                    canvas.ctx.ellipse(opt.left, opt.top, opt.width, opt.height, 0, 0, 2 * Math.PI);
                });
                canvas.style(opt);
            },
            drawElement: function (callback) {
                canvas.ctx.beginPath();
                callback();
                canvas.ctx.closePath();
            },
            style: function (opt) {
                if (!opt) return;
                if (opt.fill) {
                    canvas.ctx.fillStyle = opt.fill;
                    canvas.ctx.fill();
                }
                if (opt.stroke) {
                    canvas.ctx.strokeStyle = opt.stroke;
                    canvas.ctx.stroke();
                }
                if (opt.alpha) {
                    canvas.ctx.globalAlpha = opt.alpha;
                }
            },
            formatSize: function (opt) {
                if ((!opt.width || !opt.height) && opt.size) {
                    opt.width = opt.size;
                    opt.height = opt.size;
                }
                return opt;
            },
            raf: function (callback) {
                var call = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function (callback) { setTimeout(callback, 1000 / 60); };
                return call(callback);
            },
            init: function ($el, callback) {
                canvas.$el = $el;
                canvas.callback = callback;
                if (canvas.$el.getContext) {
                    canvas.ctx = canvas.$el.getContext("2d");
                    canvas.draw();
                }
            }
        };

        var target = document.querySelector('#canvas');
        target.height = window.innerHeight;
        target.width = window.innerWidth;

        var circles = {
            max: 20, // Max circles on screen
            spawnRate: 0.009, // Probability per frame (adjust for frequency)
            lifespan: 300, // Frames before disappear (~3s at 60fps)
            elements: [],
            rand: function (min, max) { return Math.random() * (max - min) + min; },
            frame: function () {
                // Spawn new circle randomly
                if (this.elements.length < this.max && Math.random() < this.spawnRate) {
                    this.elements.push({
                        x: this.rand(0, target.width),
                        y: this.rand(0, target.height),
                        size: this.rand(5, 15),
                        color: `hsl(${this.rand(200, 255)}, 70%, 50%)`, // Light cyan-blue tones
                        alpha: 1,
                        age: 0
                    });
                }

                // Update and draw circles
                for (let i = this.elements.length - 1; i >= 0; i--) {
                    const circle = this.elements[i];
                    circle.age++;
                    circle.alpha = 1 - (circle.age / this.lifespan); // Fade out
                    circle.size *= 1.005; // Slight expand

                    if (circle.alpha <= 0) {
                        this.elements.splice(i, 1); // Disappear
                        continue;
                    }

                    canvas.ellipse({
                        left: circle.x,
                        top: circle.y,
                        size: circle.size,
                        fill: `rgba(255, 255, 255, ${circle.alpha})` // White with fade, or use circle.color for color
                    });
                }
            },
            init: function () {
                // Initial spawn
                for (let i = 0; i < 5; i++) { // Start with a few
                    this.elements.push({
                        x: this.rand(0, target.width),
                        y: this.rand(0, target.height),
                        size: this.rand(5, 15),
                        color: `hsl(${this.rand(200, 255)}, 70%, 50%)`,
                        alpha: this.rand(0.5, 1),
                        age: this.rand(0, this.lifespan / 2)
                    });
                }
            }
        };

        window.addEventListener('load', function () {
            canvas.init(target, function () { circles.frame(); });
            circles.init();
        });

        window.addEventListener('resize', function () {
            target.height = window.innerHeight;
            target.width = window.innerWidth;
        });

        // Red Mouse Tail Animation (unchanged)
        const trailCtx = target.getContext('2d');
        let mouseTrail = [];
        const trailLength = 20;
        const trailMaxAge = 30;

        function updateCursor(e) {
            const cursor = document.createElement('div');
            cursor.style.position = 'fixed';
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
            cursor.style.width = '10px';
            cursor.style.height = '10px';
            cursor.style.background = 'red';
            cursor.style.borderRadius = '50%';
            cursor.style.pointerEvents = 'none';
            cursor.style.zIndex = '9999';
            cursor.style.opacity = '0.7';
            document.body.appendChild(cursor);
            setTimeout(() => cursor.remove(), 100);
        }

        document.addEventListener('mousemove', (e) => {
            updateCursor(e);
            mouseTrail.push({
                x: e.clientX,
                y: e.clientY,
                age: 0
            });
            if (mouseTrail.length > trailLength) {
                mouseTrail.shift();
            }
        });

        function drawTrail() {
            trailCtx.save();
            trailCtx.globalCompositeOperation = 'lighter';
            mouseTrail.forEach((point) => {
                const alpha = (1 - (point.age / trailMaxAge)) * 0.8;
                const size = (trailMaxAge - point.age) / 3;
                trailCtx.beginPath();
                trailCtx.arc(point.x, point.y, size, 0, Math.PI * 2);
                trailCtx.fillStyle = `rgba(255, 0, 0, ${alpha})`;
                trailCtx.fill();
                point.age++;
            });
            mouseTrail = mouseTrail.filter(point => point.age < trailMaxAge);
            trailCtx.restore();
            requestAnimationFrame(drawTrail);
        }

        drawTrail();
    </script>
</body>
</html>