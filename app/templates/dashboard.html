{% extends "base.html" %}
{% block title %}My Dashboard - Redrx{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>My Dashboard</h2>
            <div class="d-flex gap-2">
                <a href="{{ url_for('main.export_links') }}" class="btn btn-outline-info"><i class="fas fa-download me-1"></i> Export CSV</a>
                <a href="{{ url_for('main.index') }}" class="btn btn-shorten">Shorten New Link</a>
            </div>
        </div>

        <!-- Step 1: Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-dark border-info">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small">Total Links</h6>
                        <h3 class="mb-0 text-info">{{ stats.total_links }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-dark border-success">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small">Total Clicks</h6>
                        <h3 class="mb-0 text-success">{{ stats.total_clicks }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-dark border-primary">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small">Active Links</h6>
                        <h3 class="mb-0 text-primary">{{ stats.active_links }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-dark border-warning">
                    <div class="card-body">
                        <h6 class="text-muted text-uppercase small">Top Performer</h6>
                        <h3 class="mb-0 text-warning" style="font-size: 1.2rem;">
                            {{ stats.top_performer.short_code if stats.top_performer else 'N/A' }}
                        </h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Access Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title text-info mb-0"><i class="fas fa-key me-2"></i> API Access</h5>
                    <form action="{{ url_for('main.regenerate_api_key') }}" method="POST" onsubmit="return confirm('Are you sure? All existing API integrations will break.')">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Regenerate Key</button>
                    </form>
                </div>
                <p class="card-text text-muted mb-2">Use this key in the <code>X-API-KEY</code> header to create links via the API.</p>
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-secondary text-light">Key</span>
                    <input type="text" class="form-control bg-transparent border-secondary text-light font-monospace" value="{{ current_user.api_key }}" readonly onclick="this.select()">
                    <button class="btn btn-outline-light" onclick="navigator.clipboard.writeText('{{ current_user.api_key }}'); this.innerText='Copied!'">Copy</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Search and Filter UI -->
        <div class="card mb-4 bg-dark border-secondary">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-secondary text-muted"><i class="fas fa-search"></i></span>
                            <input type="text" id="dashboardSearch" class="form-control bg-transparent border-secondary text-light" placeholder="Search by code or URL...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="statusFilter" class="form-select bg-dark border-secondary text-light">
                            <option value="all">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="sortOrder" class="form-select bg-dark border-secondary text-light">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="clicks">Most Clicked</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <form id="bulkActionForm" action="{{ url_for('main.bulk_delete') }}" method="POST">
            <!-- Step 6: Bulk Actions -->
            <div id="bulkActions" class="mb-3 d-none animate__animated animate__fadeIn">
                <div class="alert alert-secondary d-flex justify-content-between align-items-center py-2">
                    <span id="selectedCount">0 links selected</span>
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete all selected links?')">
                        <i class="fas fa-trash me-1"></i> Delete Selected
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0" id="linksTable">
                            <thead>
                                <tr>
                                    <th width="40"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                                    <th>Code</th>
                                    <th>Long URL</th>
                                    <th>Clicks</th>
                                    <th>Last Accessed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="linksTableBody">
                                {% for url in urls %}
                                <tr class="link-row" 
                                    data-code="{{ url.short_code|lower }}" 
                                    data-url="{{ url.long_url|lower }}"
                                    data-status="{{ 'active' if url.is_active() else 'inactive' }}"
                                    data-clicks="{{ url.clicks_count }}"
                                    data-created="{{ url.created_at.timestamp() }}">
                                    <td><input type="checkbox" name="link_ids" value="{{ url.id }}" class="form-check-input link-checkbox"></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold text-info me-2">{{ url.short_code }}</span>
                                            <!-- Step 3: Quick Copy -->
                                            <button type="button" class="btn btn-link btn-sm p-0 text-muted" 
                                                    onclick="copyLink('{{ url.short_code }}', this)" 
                                                    title="Copy full URL">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="text-truncate" style="max-width: 250px;" title="{{ url.long_url }}">{{ url.long_url }}</td>
                                    <td>{{ url.clicks_count }}</td>
                                    <!-- Step 7: Last Accessed -->
                                    <td class="small text-muted">
                                        {{ url.last_accessed_at.strftime('%Y-%m-%d %H:%M') if url.last_accessed_at else 'Never' }}
                                    </td>
                                    <td>
                                        <!-- Step 5: Inline Toggle Status -->
                                        <div class="form-check form-switch">
                                            <input class="form-check-input status-toggle" type="checkbox" 
                                                   role="switch" {{ 'checked' if url.is_enabled else '' }}
                                                   onchange="toggleStatus('{{ url.short_code }}', this)">
                                            <span class="badge {{ 'bg-success' if url.is_active() else 'bg-danger' }} status-badge">
                                                {{ 'Active' if url.is_active() else 'Inactive' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('main.edit_url', short_code=url.short_code) }}" class="btn btn-sm btn-outline-warning">Edit</a>
                                            <a href="{{ url_for('main.stats', short_code=url.short_code) }}" class="btn btn-sm btn-outline-info">Stats</a>
                                            <button type="button" class="btn btn-sm btn-outline-light" 
                                                    onclick="showQRModal('{{ url.short_code }}')">QR</button>
                                            <form action="{{ url_for('main.delete_url', short_code=url.short_code) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">Del</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">You haven't shortened any links yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Pagination Controls -->
                {% if pagination.pages > 1 %}
                <div class="card-footer bg-dark border-top border-secondary">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
                                <a class="page-link bg-dark border-secondary text-light" href="{{ url_for('main.dashboard', page=pagination.prev_num) if pagination.has_prev else '#' }}">Previous</a>
                            </li>
                            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                {% if page_num %}
                                    {% if page_num == pagination.page %}
                                        <li class="page-item active"><span class="page-link bg-info border-info">{{ page_num }}</span></li>
                                    {% else %}
                                        <li class="page-item"><a class="page-link bg-dark border-secondary text-light" href="{{ url_for('main.dashboard', page=page_num) }}">{{ page_num }}</a></li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled"><span class="page-link bg-dark border-secondary text-muted">...</span></li>
                                {% endif %}
                            {% endfor %}
                            <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
                                <a class="page-link bg-dark border-secondary text-light" href="{{ url_for('main.dashboard', page=pagination.next_num) if pagination.has_next else '#' }}">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">QR Code</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="qrModalBody">
                <div class="spinner-border text-info" role="status"></div>
            </div>
            <div class="modal-footer border-secondary">
                <a id="qrDownloadBtn" href="#" class="btn btn-primary w-100" download>Download PNG</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const baseDomain = "{{ config['BASE_DOMAIN'] }}";

// Step 3: Quick Copy Logic
function copyLink(code, btn) {
    const url = `https://${baseDomain}/${code}`;
    navigator.clipboard.writeText(url);
    const originalIcon = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check text-success"></i>';
    setTimeout(() => btn.innerHTML = originalIcon, 2000);
}

// Step 5: Toggle Status Logic
function toggleStatus(code, checkbox) {
    fetch(`/toggle-status/${code}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        const badge = checkbox.nextElementSibling;
        if (data.is_enabled) {
            badge.innerText = 'Active';
            badge.className = 'badge bg-success status-badge';
        } else {
            badge.innerText = 'Inactive';
            badge.className = 'badge bg-danger status-badge';
        }
    });
}

// QR Modal Logic
function showQRModal(code) {
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    const body = document.getElementById('qrModalBody');
    const downloadBtn = document.getElementById('qrDownloadBtn');
    
    body.innerHTML = '<div class="spinner-border text-info"></div>';
    downloadBtn.href = `/${code}/qr`; 
    
    const img = new Image();
    img.src = `/${code}/qr`;
    img.className = 'img-fluid rounded mb-2';
    img.onload = () => body.innerHTML = `<img src="${img.src}" class="img-fluid rounded">`;
    
    modal.show();
}

// Step 2 & 6: Search, Filter, Sort and Bulk Logic
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('dashboardSearch');
    const statusFilter = document.getElementById('statusFilter');
    const sortOrder = document.getElementById('sortOrder');
    const rows = Array.from(document.querySelectorAll('.link-row'));
    const tableBody = document.getElementById('linksTableBody');

    function updateTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;

        rows.forEach(row => {
            const matchesSearch = row.dataset.code.includes(searchTerm) || row.dataset.url.includes(searchTerm);
            const matchesStatus = statusValue === 'all' || row.dataset.status === statusValue;
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });

        // Sorting
        const visibleRows = rows.filter(r => r.style.display !== 'none');
        visibleRows.sort((a, b) => {
            if (sortOrder.value === 'clicks') return b.dataset.clicks - a.dataset.clicks;
            if (sortOrder.value === 'oldest') return a.dataset.created - b.dataset.created;
            return b.dataset.created - a.dataset.created;
        });
        
        visibleRows.forEach(r => tableBody.appendChild(r));
    }

    searchInput.addEventListener('input', updateTable);
    statusFilter.addEventListener('change', updateTable);
    sortOrder.addEventListener('change', updateTable);

    // Bulk Actions
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.link-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');

    function updateBulkUI() {
        const checked = Array.from(checkboxes).filter(c => c.checked);
        bulkActions.classList.toggle('d-none', checked.length === 0);
        selectedCount.innerText = `${checked.length} links selected`;
    }

    selectAll.addEventListener('change', () => {
        checkboxes.forEach(c => {
            if (c.closest('tr').style.display !== 'none') c.checked = selectAll.checked;
        });
        updateBulkUI();
    });

    checkboxes.forEach(c => c.addEventListener('change', updateBulkUI));
});
</script>
<style>
.status-badge { transition: all 0.3s ease; font-size: 0.7rem; margin-left: 5px; }
.card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
.btn-group .btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
</style>
{% endblock %}